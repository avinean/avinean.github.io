window.evolvShims={performance:window.performance,PromiseShim:window.Promise},function(e){"use strict";let t=!1;t||([function(){const e=document.scripts;for(let t=0;t<e.length;t+=1){const i=e[t].dataset;"evolvWebsite"in i&&!("evolvEnvironment"in i)&&(i.evolvEnvironment=i.evolvWebsite)}}].forEach(e=>e()),t=!0);class i{constructor(){this.promise=new e.PromiseShim((e,t)=>{this.resolve=e,this.reject=t})}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}}const r=window.document,n=window.localStorage,s=window.sessionStorage,o=window.addEventListener.bind(window),a=(window.removeEventListener.bind(window),window.clearTimeout.bind(window),window.setTimeout.bind(window),r.createElement.bind(r)),c=r.querySelector.bind(r),d=r.querySelectorAll.bind(r),l=window.decodeURIComponent,u=new class{constructor(e){this.selector=e,this.element=c(e),this.element||console.warn("Emitter cannot be attached because selector does not match any element")}emit(e,t){if(!this.element)return;let i;"function"==typeof CustomEvent?i=new CustomEvent(e,{detail:t}):(i=document.createEvent("CustomEvent"),i.initCustomEvent(e,!1,!1,t)),this.element.dispatchEvent(i)}on(e,t){this.element&&this.element.addEventListener(e,e=>{t(e.detail)})}off(e,t){this.element&&this.element.removeEventListener(e,e=>{t(e.detail)})}}("script[data-evolv-environment]");var h;!function(t){function r(e="default"){return t.runtime.then(t=>t.emitEvent(e))}t.version="1.20.2",t.isReady=!1,t.editor=new i,t.runtime=new i,t.scout=new i,t.ready=e.PromiseShim.all([t.runtime,t.scout]).then(e=>(t.isReady=!0,e)),t.trigger=function(e){if(!t.isReady)throw new Error("The Evolv runtime is not yet ready.");r(e)},t.triggerAsync=r,t.off=function(e,t){return u.off(e,t),window.evolv},t.on=function(e,t){return u.on(e,t),window.evolv},t.scripts={}}(h||(h={})),window.evolv=window.evolv||h,window.ascend=window.ascend||h;const p=history.pushState;history.pushState=function(...e){let t;p.apply(history,e);const i="pushstate_evolv";Event.prototype.constructor?t=new CustomEvent(i,{}):(t=document.createEvent("Event"),t.initEvent(i)),window.dispatchEvent(t)};class f extends Error{constructor(){super("Configuration not found. The Evolv script tag must specify the 'data-evolv-environment' attribute")}}class m{constructor(e){this.value=e}get current(){return this.value}set current(e){this.value=e}}const g=Array.from,v=navigator.sendBeacon.bind(navigator),y=window.URLSearchParams;function w(e){return new Map(e)}function x(e){return new Set(e)}function b(e,t){const i=x(),r=e.size<=t.size?e:t,n=e.size<=t.size?t:e;for(const e of g(r))n.has(e)&&i.add(e);return i}function E(e,t){const i=x(e);for(const r of g(t))e.has(r)&&i.delete(r);return i}function k(){return`${Math.round(1e8*Math.random())}_${Date.now()}`}const $={environmentId:"",autoLoad:!0,reconcile:"leave",apiUrl:"https://participants.evolv.ai",sdkUrl:"https://media.evolv.ai/releases/1.20.2/runtime.min.mjs",editorUrl:"https://media.evolv.ai/releases/1.20.2/editor.js",cookieDomains:[""],editorAdapterUrl:"https://app.ascend.ai/adapter.js"};function A(...e){const t="[Evolv]"+e.map(e=>`[${e}]`).join("");return{debug(e,...t){},error(e,...i){console.error(t,e,...i)},info(e,...i){console.info(t,e,...i)},log(e,...i){console.log(t,e,...i)},warn(e,...i){console.warn(t,e,...i)},clone:(...t)=>A(...e,...t)}}const I=2592e6,S=63072e6,R=/^(.+?)=(.*)$/;var C;function O(){return(r.cookie?r.cookie.split("; "):[]).reduce((e,t)=>{const i=R.exec(t);if(!i)return e;const r=l(i[1]),n=l(i[2]);let s;try{s=JSON.parse(n)}catch(e){s=n.replace(/^"(.*)"$/,"$1")}return e.set(r,s),e},new Map)}function T(e,t,i={}){const n=i.domain?"; domain="+i.domain:"",s="; path="+(i.path||"/");let o="";if(i.millis){const e=new Date;e.setTime(e.getTime()+i.millis),o="; expires="+e.toUTCString()}r.cookie=`${e}=${t}${o}${n}${s}`}
/*! *****************************************************************************
	Copyright (c) Microsoft Corporation. All rights reserved.
	Licensed under the Apache License, Version 2.0 (the "License"); you may not use
	this file except in compliance with the License. You may obtain a copy of the
	License at http://www.apache.org/licenses/LICENSE-2.0

	THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
	KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
	WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
	MERCHANTABLITY OR NON-INFRINGEMENT.

	See the Apache Version 2.0 License for specific language governing permissions
	and limitations under the License.
	***************************************************************************** */
function j(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i}function P(e,t,i,r){var n,s=arguments.length,o=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(o=(s<3?n(o):s>3?n(t,i,o):n(t,i))||o);return s>3&&o&&Object.defineProperty(t,i,o),o}function _(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function F(e){return s.getItem(e)}!function(e){e.CandidateIds="evolv:cids",e.DeviceId="evolv:did",e.SessionId="evolv:sid",e.UserId="evolv:uid"}(C||(C={}));class q extends Error{}function M(t){const{editorUrl:i}=t.config,r=i.replace(/(\.min)?\.js$/,"$1.mjs"),n=i.replace(/(\.min)?\.js$/,"");if(c(`script[src ^= '${n}']`))return window.evolv.editor;try{return(s=i,o=r,o=o||s,s="Proxy"in window&&navigator.sendBeacon?o:s,document.body||function(){const e=window.navigator.userAgent;return e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0}()||!document.querySelector(`[src $= '${s}']`)?function(t){return new e.PromiseShim((e,i)=>{const r=document.createElement("script");r.defer=!0,r.src=t,r.onload=e,r.onerror=i,document.head.appendChild(r)})}(s):e.PromiseShim.resolve()).then(()=>window.evolv.editor)}catch(i){return t.logger.error("Editor failed to load"),e.PromiseShim.reject(new q)}var s,o}const D={record(e,t,i){e.dataset.evolvTreatment=i}},U={record(e,t,i){}},z={record(e,t,i){e.dataset.evolvStatus=i}};function N(e,t,i=U){return r=>{if(!e(r))throw new TypeError("The mutation object is not valid for this mutator.");const n=new WeakMap;return{mutate(){const e=t(r,!1);let s=e.next();for(;!s.done;){const[t,o]=s.value;n.has(t)||n.set(t,o),i.record(t,o,"mutated"),s=e.next(r.value)}},revert(){const e=t(r,!0);let s=e.next();for(;!s.done;){const[t,r]=s.value;i.record(t,r,"reverted"),s=n.has(t)?e.next(n.get(t)):e.next(r)}}}}}const L=N((function(e){return"attribute"===e.type}),(function*(e){const t=d(e.selector);for(const i of g(t)){const t=i.getAttribute(e.property),r=yield[i,t];i.setAttribute(e.property,r)}}),D),B=N((function(e){return"classNames"===e.type}),(function*(e,t){const i=d(e.selector);for(const r of g(i)){const i=r.classList.value,n=yield[r,i];t||!e.additive?r.classList.value=n:n.split(" ").forEach(e=>{r.classList.add(e)})}}),D);function W(e,t){const i=a("script");return i.id=e,i.text=function(e,t,i=[],r="mutator"){const n=i.join(", ");return`(function(scripts) {\n\tscripts['${e}'] = ${"function"==typeof t?t.toString():`function ${r}(${n}) { ${t} }`};\n})(window.evolv.scripts);`}(e,t||"",["api"]),i.dataset.evolvStatus="unapplied",i}function J(e,t,i={}){const{apiUrl:r,environmentId:n}=e,{uid:s,sid:o,previewId:a,previewCid:c}=function(e=[]){const t=O(),i=t.get(C.UserId)||k(),r=t.get(C.DeviceId)||k(),n=t.get(C.SessionId)||k();for(const t of e)T(C.UserId,i,{domain:t,millis:S}),T(C.DeviceId,r,{domain:t,millis:S}),T(C.SessionId,n,{domain:t,millis:I});return{uid:i,sid:n,did:r,previewId:F("evolv-previewid"),previewCid:F("evolv-previewcid"),candidateToken:F("evolvCandidateToken")}}(e.cookieDomains),d=Object.assign({type:t,uid:s,sid:o},i);let l="events";return(a||c)&&(l="preview-events"),v(`${r}/v1/${n}/${l}`,JSON.stringify(d)),d}const H=window.evolv.scripts;function V(e){if("javascript"!==(t=e).type||!("value"in t)||!("undoCode"in t))throw new TypeError("The mutation object is not valid for this mutator.");var t;const i=new se,n="evolv_"+e.id,s="~"+n;let o=c(`script[id = '${n}']`),a=c(`script[id = '${s}']`);return o||(o=W(n,e.value),r.body.appendChild(o)),a||(a=W(s,e.undoCode),r.body.appendChild(a)),{mutate(e){if(!o)return;const t=o.dataset.evolvStatus;if("applied"!==t&&"errored"!==t)try{H[n](i),z.record(o,n,"applied")}catch(t){throw z.record(o,n,"errored"),e.logger.error(`An error occurred in JavaScript mutator '${n}'\n`,o,"\n",t),t}finally{if(a){const e=a.dataset.evolvStatus;"errored"!==e&&"unapplied"!==e&&z.record(a,s,"reverted")}}},revert(e){if(!a)return;const t=a.dataset.evolvStatus;if("applied"!==t&&"errored"!==t)try{H[s](i),i&&i.dispose(),z.record(a,s,"applied")}catch(t){z.record(a,s,"errored"),e.logger.warn(`An error in JavaScript undo mutator '${s}' was suppressed because the page plan is reverting\n`,a,"\n",t)}finally{o&&"errored"!==o.dataset.evolvStatus&&z.record(o,n,"reverted")}}}}function G(e){if("stylesheet"!==e.type)throw new TypeError("The mutation object is not valid for this mutator.");return{mutate(){if(!c(`style[id = '${e.id}']`)){const t=r.createElement("style");t.id=e.id,t.textContent=e.value.replace(/\\n/g,"\n").replace(/\\t/g,"\t"),r.head.appendChild(t),D.record(t,e.id,"mutated")}},revert(){const t=c(`style[id = '${e.id}']`);t&&(t.remove||t.removeNode).call(t)}}}const K=N((function(e){return"html"===e.type}),(function*(e){const t=d(e.selector);for(const e of g(t)){const t=e.innerHTML;e.innerHTML=yield[e,t]}}),D),Q=N((function(e){return"style"===e.type}),(function*(e){const t=g(d(e.selector));for(const i of t)if(i.style){const t=i.style[e.property];i.style[e.property]=yield[i,t]}}),D),X=N((function(e){return"text"===e.type}),(function*(e){const t=d(e.selector);for(const e of g(t)){const t=e.textContent;e.textContent=yield[e,t]}}),D),Y=(e,t,i)=>L({type:"attribute",selector:e,property:t,value:i}),Z=(e,t,i)=>B({type:"classNames",selector:e,property:"",value:Array.isArray(t)?t.join(" "):t,additive:i}),ee=(e,t)=>K({type:"html",selector:e,property:"",value:t}),te=(e,t,i)=>Q({type:"style",selector:e,property:t,value:i}),ie=(e,t,i,r)=>G({type:"stylesheet",value:`\n\t\t\t${e} { ${t}: ${i}${r?" !important":""}; }\n\t\t`.trim(),id:k()}),re=(e,t)=>G({type:"stylesheet",value:t,id:e}),ne=(e,t)=>X({type:"text",selector:e,property:"",value:t});class se{constructor(e=A("API")){this.logger=e,this.disposers=[],this.args={logger:e}}attribute(e,t,i){let r=Y(e,t,i);return r.mutate(this.args),this.addDisposer(()=>{r&&r.revert(this.args),r=null})}classNames(e,t,i=!1){let r=Z(e,t,i);return r.mutate(this.args),this.addDisposer(()=>{r&&r.revert(this.args),r=null})}html(e,t){let i=ee(e,t);return i.mutate(this.args),this.addDisposer(()=>{i&&i.revert(this.args),i=null})}inlineStyle(e,t,i){let r=te(e,t,i);return r.mutate(this.args),this.addDisposer(()=>{r&&r.revert(this.args),r=null})}fn(e,t){return"function"==typeof e&&e(),this.addDisposer(()=>{"function"==typeof t&&t()})}observe(e,t,i={childList:!0}){const n=r.querySelectorAll(e),s=new MutationObserver(t);return n.forEach(e=>{s.observe(e,i)}),this.addDisposer(()=>{s.disconnect()})}poll(e,t,i=100){let r=setInterval(()=>{e()&&(clearInterval(r),t())},i);return this.addDisposer(()=>{clearInterval(r),r=null})}style(e,t,i,r){let n=ie(e,t,i,r);return n.mutate(this.args),this.addDisposer(()=>{n&&n.revert(this.args),n=null})}stylesheet(e,t=k()){let i=re(t,e);return i.mutate(this.args),this.addDisposer(()=>{i&&i.revert(this.args),i=null})}text(e,t){let i=ne(e,t);return i.mutate(this.args),this.addDisposer(()=>{i&&i.revert(this.args),i=null})}wait(e,t){let i=setTimeout(t,e);return this.addDisposer(()=>{clearTimeout(i),i=null})}dispose(){for(const e of this.disposers)e();this.disposers=[]}addDisposer(e){return this.disposers.push(e),e}}class oe{constructor(e){this.plan=e}addInitializer(e){this.plan.addInitializer(e)}attribute(e,t,i){const r=Y(e,t,i);this.plan.addMutator(r)}classNames(e,t,i=!1){const r=Z(e,t,i);this.plan.addMutator(r)}compound(e,t="",i="",r=""){const n=((e,t="",i="",r="")=>function(e){if("compound"!==(t=e).type||!("script"in t)||!("styles"in t))throw new TypeError("The mutation object is not valid for this mutator.");var t;const i=V({type:"javascript",id:e.id,value:e.script,undoCode:e.undoCode}),r=G({type:"stylesheet",id:e.id,value:e.styles});return{mutate(e){i.mutate(e),r.mutate(e)},revert(e){i.revert(e),r.revert(e)}}}({type:"compound",value:void 0,id:e,script:i,styles:t,undoCode:r}))(e,t,i,r);this.plan.addMutator(n)}html(e,t){const i=ee(e,t);this.plan.addMutator(i)}inlineStyle(e,t,i){const r=te(e,t,i);this.plan.addMutator(r)}javascript(e,t,i=""){const r=((e,t,i="")=>V({type:"javascript",value:t,id:e,undoCode:i}))(e,t,i);this.plan.addMutator(r)}noop(){const e={mutate(){},revert(){}};this.plan.addMutator(e)}style(e,t,i,r=!1){const n=ie(e,t,i,r);this.plan.addMutator(n)}stylesheet(e,t){const i=re(e,t);this.plan.addMutator(i)}text(e,t){const i=ne(e,t);this.plan.addMutator(i)}}function ae(e){const[,t]=e.split(":");return{eid:t,cid:e}}class ce{constructor(e,t,i,r){this.page=e,this.parent=t,this.predicate=i,this.mutators=x(),this.initializers=[],this.context=Object.assign({},r,{logger:r.logger.clone("Page "+this.page.id)}),this.api=new se(this.context.logger)}get logger(){return this.context.logger}addInitializer(e){this.initializers.push(e)}addMutator(e){this.mutators.add(e)}run(e=!1){if(e||this.predicate(this.context)){const{emit:e}=this.context,t=""+this.predicate.toString();this.initializers.forEach(e=>{e(this.api)}),this.mutators.forEach(e=>{e.mutate(this.context)});const{eid:i,cid:r}=ae(this.parent.id);return e("activated",{planId:this.parent.id,experimentId:i,candidateId:r,predicate:t,page:this.page}),!0}return!1}revert(e=!1){if(e||this.predicate(this.context)){const{emit:e}=this.context,t=""+this.predicate.toString();this.mutators.forEach(e=>{e.revert(this.context)}),this.api.dispose();const{eid:i,cid:r}=ae(this.parent.id);return e("reverted",{planId:this.parent.id,experimentId:i,candidateId:r,predicate:t,page:this.page}),!0}return!1}}class de{constructor(e){this.context=e,this.messageFn=e=>e?"Filter passed":"Filter blocked",this.not=this.not||{},this.includeNots()}test(e){const t=this.predicate(e);return{passed:t,message:t?null:this.messageFn(t)}}includeNots(){for(const e of Object.keys(this.not))this.not[e]=(...t)=>{this[e](...t);const i=this.predicate,r=this.messageFn;this.predicate=function(e){return!i(e)},this.messageFn=function(e){return r(!e)}}}}function le(e){return e&&"object"==typeof e&&!Array.isArray(e)}function ue(e,t){if(le(e)&&t){for(let i=0,r=t.split("."),n=r.length;i<n;i++)if(!(e=e[r[i]]))return e;return e}}const he={web:{client:{browser:"unspecified"}},cookie:{},device:"unspecified",location:"",platform:"unspecified",queryStringParameters:{},referrerUrl:r.referrer,userAttributes:{},referrer_url:r.referrer};function pe(e){const t=window.evolvPreload||{},i=Object.assign({},he,e,{cookie:(r=O(),g(r).reduce((e,[t,i])=>(e[t]=i,e),{})),queryStringParameters:fe(),userAttributes:t.userAttributes||{}});var r;return void 0===e.country&&(i.country=e.location),i}function fe(){const e=new y(location.search),t=[];return e.forEach((e,i)=>{t.push([i,e])}),function(e){const t={};for(const[i,r]of e)t[i]=r;return t}(t)}function me(){return(e,t)=>{if(!(e instanceof de))throw new Error("This method must belong to a class of type Filter");e.not||(e.not={}),e.not[t]=void 0}}function ge(e=""){const t=e.match(/^\s*\/(.*)\/([gmiyus]*)\s*$/);if(t){e=t[1];const i=t[2];return new RegExp(e,i)}return new RegExp(e)}class ve extends Error{constructor(e){super(`Experiment ${e} has already been added.`)}}class ye extends Error{constructor(e){super(`Stage ${e.number} cannot proceed because its always-execute scripts differ from the previous stage`)}}class we extends Error{constructor(e){super(`Invalid filter operator for field '${e}'.`)}}class xe extends de{constructor(e,t){super(e),this.field=function(e){if("string"!=typeof e)throw new TypeError("Argument should be of type string");return"_"===e?"_":e.replace(/([^^])_([^$])/g,(e,t,i)=>`${t}${i.toUpperCase()}`).replace(/(^_|_$)/g,"")}(t)}equals(e,t){this.predicate=i=>{const r=i[this.field];return!(!e||!(e in r))&&r[e]===t},this.messageFn=i=>i?`The key '${e}' in '${this.field}' equals '${t}'.`:`The key '${e}' in '${this.field}' does not equal '${t}'.`}exists(e){this.predicate=t=>{const i=t[this.field];return-1!==Object.keys(i).indexOf(e)},this.messageFn=t=>t?`The key '${e}' exists in '${this.field}'.`:`The key '${e}' does not exist in '${this.field}'.`}contains(e,t){this.predicate=i=>{const r=i[this.field];return!(!e||!(e in r))&&-1!==r[e].indexOf(t)},this.messageFn=i=>i?`The key '${e}' in '${this.field}' contains '${t}'.`:`The key '${e}' in '${this.field}' does not contain '${t}'.`}static fromRule(e,t){const i=new xe(t,e.field);switch(e.operator){case"kv_contains":i.contains(e.value[0],e.value[1]);break;case"kv_not_contains":i.not.contains(e.value[0],e.value[1]);break;case"kv_equal":i.equals(e.value[0],e.value[1]);break;case"kv_not_equal":i.not.equals(e.value[0],e.value[1]);break;case"exists":{const t=Array.isArray(e.value)?e.value[0]:e.value;i.exists(t);break}case"not_exists":{const t=Array.isArray(e.value)?e.value[0]:e.value;i.not.exists(t);break}default:throw new we(e.field)}return i}}P([me(),_("design:type",Function),_("design:paramtypes",[String,Object]),_("design:returntype",void 0)],xe.prototype,"equals",null),P([me(),_("design:type",Function),_("design:paramtypes",[String]),_("design:returntype",void 0)],xe.prototype,"exists",null),P([me(),_("design:type",Function),_("design:paramtypes",[String,Object]),_("design:returntype",void 0)],xe.prototype,"contains",null);class be extends de{constructor(e,t){super(e),this.field=t}equals(e){this.predicate=t=>ue(t,this.field)===e,this.messageFn=t=>t?`Audience field '${this.field}' equals '${e}'.`:`Audience field '${this.field}' does not equal '${e}'.`}matches(e){this.predicate=t=>e.test(ue(t,this.field)),this.messageFn=t=>t?`Audience field '${this.field}' matches ${e}.`:`Audience field '${this.field}' does not match ${e}.`}startsWith(e){this.predicate=t=>function(e,t){return!(t.length>e.length)&&e.substr(0,t.length)===t}(ue(t,this.field),e),this.messageFn=t=>t?`Audience field '${this.field}' starts with '${e}'.`:`Audience field '${this.field}' does not start with '${e}'.`}contains(e){this.predicate=t=>{const i=ue(t,this.field);return!!i&&-1!==i.indexOf(e)},this.messageFn=t=>t?`Audience field '${this.field}' contains '${e}'.`:`Audience field '${this.field}' does not contain '${e}'.`}exists(){this.predicate=e=>void 0!==ue(e,this.field),this.messageFn=e=>e?`The key '${this.field}' exists in audience.`:`The key '${this.field}' does not exist in audience.`}static fromRule(e,t){const i=new be(t,e.field);switch(e.operator){case"equal":i.equals(e.value);break;case"not_equal":i.not.equals(e.value);break;case"regex_match":i.matches(ge(e.value));break;case"not_regex_match":i.not.matches(ge(e.value));break;case"starts_with":i.startsWith(e.value);break;case"not_starts_with":i.not.startsWith(e.value);break;case"contains":i.contains(e.value);break;case"not_contains":i.not.contains(e.value);break;case"exists":i.exists();break;default:throw new we(e.field)}return i}}function Ee(e){return"combinator"in e}function ke(e){return e&&-1!==["cookie","query_parameter","user_attributes"].indexOf(e.field)}function $e(e){return function(e){return e&&"field"in e&&"operator"in e&&"value"in e}(e)&&"string"==typeof e.value}function Ae(e,t){const i=[],r=Array.isArray(e)?e:[e];for(const e of r){let r=null;Ee(e)?r=Ie.fromRule(e,t):ke(e)?r=xe.fromRule(e,t):$e(e)&&(r=be.fromRule(e,t)),r&&i.push(r)}return i}P([me(),_("design:type",Function),_("design:paramtypes",[String]),_("design:returntype",void 0)],be.prototype,"equals",null),P([me(),_("design:type",Function),_("design:paramtypes",[RegExp]),_("design:returntype",void 0)],be.prototype,"matches",null),P([me(),_("design:type",Function),_("design:paramtypes",[String]),_("design:returntype",void 0)],be.prototype,"startsWith",null),P([me(),_("design:type",Function),_("design:paramtypes",[String]),_("design:returntype",void 0)],be.prototype,"contains",null);class Ie extends de{constructor(e,t,i){super(e),this.combinator=t,this.handler=i,this.builder=new Me(e),this.predicate=e=>{const t=g(this.builder.filters);switch(this.combinator){case"and":return t.every(t=>t.test(e).passed);case"or":return t.some(t=>t.test(e).passed);default:throw new Error(`Invalid combinator '${this.combinator}'`)}},this.messageFn=e=>{switch(this.combinator){case"and":return e?"All conditions of AND filter were met.":"One or more conditions of AND filter were not met.";case"or":return e?"One or more conditions of OR filter were met.":"No conditions of OR filter were met.";default:throw new Error(`Invalid combinator '${this.combinator}'`)}},i(this.builder)}static fromRule(e,t){return new Ie(t,e.combinator,i=>{const r=Ae(e.rules,t);for(const e of r)i.addFilter(e)})}}function Se(e,t,i=!1){const r={passed:!0,exhaustive:i,results:[]};for(const n of g(e)){const e=n.test(t);if(r.results.push(e),e.passed||(r.passed=!1),!i&&!r.passed)break}return r}class Re{constructor(e,t,i){this.stage=t,this.recorder=i,this.pages=x(),this.filters=x(),this.elapsedTime=1/0,this._applied=!1,this.onPopState=()=>{this.revert(!0),this.run()},this.onPushState=()=>{this.revert(!0),this.run()},this.settings=Object.assign({renderTimeout:1e3},e),this.context=Object.assign({},t.context,{logger:t.context.logger.clone("Experiment "+this.id)}),o("popstate",this.onPopState),o("pushstate_evolv",this.onPushState),this.markTime()}get applied(){return this._applied}get audienceContext(){return this.stage.audience}get entryPages(){return g(this.pages).filter(e=>e.page.isEntryPoint)}get filterResults(){return Se(this.filters,this.audienceContext)}get id(){return this.settings.candidateId}get candidateId(){return this.settings.candidateId}get experimentId(){return this.settings.candidateId.replace(/^\w+:/,"")}get logger(){return this.context.logger}run(e=!1){const t=this.elapsedTime-this.settings.renderTimeout,i=this.recorder.checkIfContaminated(this.candidateId),{eid:r,cid:n}=ae(this.candidateId);if(!this.filterResults.passed)return!1;if(i)return u.emit("notrendered",{candidateId:n,experimentId:r,planId:this.id,reason:"contaminated"}),this.logger.warn("Plan has been contaminated and therefore will not run"),!1;if(!e&&t>0)return this.recorder.markContaminated(this.candidateId,"timeout-exceeded","rendertime: "+this.elapsedTime),u.emit("notrendered",{candidateId:n,experimentId:r,planId:this.id,reason:"timeout-exceeded"}),this.logger.warn(`Render timeout exceeded by ${t/1e3} seconds`),!1;try{return this._applied=this.runApplicablePlans(e),!this._applied||(this.recorder.markConfirmed(this.candidateId),u.emit("rendered",{candidateId:n,experimentId:r,planId:this.id}),!0)}catch(e){return this.recorder.markContaminated(this.candidateId,"error-thrown",""+e.message),u.emit("notrendered",{candidateId:n,experimentId:r,planId:this.id,reason:"error-thrown"}),this.revert(),!1}}revert(e=!1){this.pages.forEach(t=>{t.revert(e)}),this._applied=!1}markTime(){if(0===e.performance.getEntriesByName("ready-state-interactive").length)this.elapsedTime=0;else{e.performance.measure("elapsed-since-interactive","ready-state-interactive");const t=e.performance.getEntriesByName("elapsed-since-interactive"),i=t[t.length-1];this.elapsedTime=i.duration}}runApplicablePlans(e=!1){const t=this.recorder.checkIfConfirmed(this.candidateId)?this.pages:this.entryPages;let i=!1;for(const r of g(t))r.run(e)&&(i=!0);return i}}function Ce(e,t){const i=e instanceof Set?e:x(e),r=t instanceof Set?t:x(t);return{added:E(r,i),removed:E(i,r),unchanged:b(i,r)}}class Oe{constructor(e,t){if(this.relation=e,this.partitions=w(),this.items=x(),t)for(const e of g(t))this.add(e)}add(e){const t=this.relation(e);return this.partitions.has(t)||this.partitions.set(t,x()),this.partitions.get(t).add(e),this.items.add(e),this}delete(e){const t=this.relation(e),i=this.partitions.get(t);return i&&(i.delete(e),0===i.size&&this.partitions.delete(t)),this.items.delete(e)}static compare(e,t,i){const r=e instanceof Oe?e:new Oe(i,e),n=t instanceof Oe?t:new Oe(i,t);return{items:Ce(r.items,n.items),partitions:Ce(r.partitions.keys(),n.partitions.keys())}}}class Te{constructor(){this._items=[]}get isEmpty(){return 0===this.size}get items(){return this._items}get size(){return this.items.length}enqueue(e){this.items.push(e)}dequeue(){return this.items.shift()}}function je(e,t){return ae(e).eid===t}function Pe(e){return ae(e).eid}let _e=1;class Fe{constructor(e,t,i,r,n,s){this.uid=e,this.aeExecutor=t,this.experimentRecorder=i,this.triggerManager=r,this.audienceRef=n,this.plans=w(),this.number=_e,this.context=Object.assign({},s,{logger:A("Runtime","Stage "+this.number)}),_e+=1}get audience(){return this.audienceRef.current}get isEmpty(){return 0===this.plans.size}get logger(){return this.context.logger}reconcile(e){const{config:t}=this.context,{items:i,partitions:r}=Oe.compare(e.keys(),this.plans.keys(),Pe);return{plansToAdd:i.added,plansToRevert:"revert"===t.reconcile?i.removed:qe(i,r.unchanged)}}runAlwaysExecute(){if(!this.aeExecutor.canStageProceed())throw new ye(this);this.aeExecutor.execute(this.context)}}function qe(e,t){const{removed:i}=e,r=x();for(const e of g(t)){const t=t=>je(t,e);for(const e of g(i).filter(t))r.add(e)}return r}class Me{constructor(e){this.context=e,this._filters=x()}get filters(){return this._filters}addFilter(e){return this.filters.add(e),e}fromRules(e){const t=Ae(e,this.context);for(const e of t)this.addFilter(e)}browser(){return this.addFilter(new be(this.context,"web.client.browser"))}cookie(){return this.addFilter(new xe(this.context,"cookie"))}device(){return this.addFilter(new be(this.context,"device"))}group(e,t){return this.addFilter(new Ie(this.context,e,t))}javascript(){}location(){return this.addFilter(new be(this.context,"location"))}platform(){return this.addFilter(new be(this.context,"platform"))}queryParameter(){return this.addFilter(new xe(this.context,"queryStringParameters"))}referrerUrl(){return this.addFilter(new be(this.context,"referrerUrl"))}userAttribute(){return this.addFilter(new xe(this.context,"userAttributes"))}}class De{constructor(e){this.plan=e,this.filterBuilder=new Me(this.plan.context),this.plan.filters=this.filterBuilder.filters}get audience(){return this.filterBuilder}page(e,t,i){t=t||(()=>!1);const r=Object.assign({type:"url",isEntryPoint:!0},e);"manual"===r.type&&(t=t=>t.state.manualActivations.has(e.id));const n=new ce(r,this.plan,t,this.plan.context);i(new oe(n)),this.plan.pages.add(n)}manualActivation(e,t){this.page(Object.assign({},e,{type:"manual"}),null,t)}}class Ue{constructor(e){this.key=e,this.attached=!1,this.context=null,this.count=0}get triggered(){return this.count>0}attach(e){this.context=e,this.attached=!0,this.onAttach()}detach(){this.onDetach(),this.attached=!1,this.context=null}trigger(e){const{config:t,emit:i,logger:r}=this.context;if(!this.attached)return;const n=e?{score:e}:void 0,s=J(t,this.key,n);i("triggered",{kind:this.kind,data:s}),r.debug(`Goal '${this}' was triggered`),this.count+=1}toString(){return""+this.kind}}class ze extends Ue{constructor(e,t,i){super(e),this.predicate=t,this.selector=i,this.kind="clickEvent",this.listeners=x(),this.onClick=()=>{this.trigger()}}onAttach(){if(!this.predicate(this.context))return;const e=d(this.selector);for(const t of g(e))t.addEventListener("click",this.onClick),this.listeners.add(t)}onDetach(){for(const e of g(this.listeners))e.removeEventListener("click",this.onClick);this.listeners.clear()}toString(){return`Click Event (${this.selector})`}}class Ne extends Ue{constructor(e){super(e),this.kind="manual"}get triggered(){return!1}onAttach(){}onDetach(){}trigger(){this.attached&&super.trigger()}toString(){return`Manual Trigger (${this.key})`}}class Le extends Ue{constructor(e,t){super(e),this.predicate=t,this.kind="routeEntry"}onAttach(){this.predicate(this.context)&&this.trigger()}onDetach(){}toString(){return`Route Entry (${this.predicate})`}}class Be{constructor(e,t){this.stage=e,this.experimentRecorder=t}experiment(e,t){const{audience:i,logger:r,plans:n}=this.stage,s=new Re(e,this.stage,this.experimentRecorder);t(new De(s));const{id:o}=s;if(n.has(o)){const e=new ve(o);throw r.error(e.message),e}n.set(o,s),Se(s.filters,i).passed?this.experimentRecorder.markSelected(s.candidateId):this.experimentRecorder.markFiltered(s.candidateId,"")}exclude(e){this.experimentRecorder.markExcluded(e,"Filtered by server")}alwaysExecute(e,t){this.stage.aeExecutor.add(e,t)}clickEventTrigger(e,t,i=(()=>!0)){const r=new ze(e,i,t);this.stage.triggerManager.add(r)}routeEntryTrigger(e,t){const i=new Le(e,t);this.stage.triggerManager.add(i)}}class We{constructor(){this.manualActivations=x(),Object.freeze(this)}}const Je=window.evolv.scripts;class He{constructor(){this.queue=new Te,this.scripts=w(),this.scriptsRan=x()}add(e,t){if(this.scripts.has(e))return;const i=document.body||document.head,r=W("evolv_alwaysExecute_"+e,t);i.appendChild(r),this.scripts.set(e,r),this.queue.enqueue(e)}canStageProceed(){return 0===this.scriptsRan.size||0===E(x(this.queue.items),this.scriptsRan).size}execute(e){for(;!this.queue.isEmpty;){const t=this.queue.dequeue(),i=this.scripts.get(t),r=Je[i.id];if(r)try{r(),this.scriptsRan.add(t),z.record(i,"","applied"),e.logger.debug(`Always-execute script '${t}' ran`)}catch(r){throw z.record(i,"","errored"),e.logger.error(`Always-execute script '${t}' encountered an error\n`,i,"\n",r),r}}}}const Ve={l:[],cf:[],ct:[],f:[],s:[]};class Ge{constructor(e){this.context=e,this.experiments=w();const t=(i=Ve,n=C.CandidateIds,r=(r=O().get(n)||null)||{},Object.keys(i).reduce((e,t)=>(e[t]=void 0===r[t]?i[t]:r[t],e),{}));var i,r,n;const s=t.l,o=function(e){const t=e.l,i=j(e,["l"]);if(!e)return i;for(const e of Object.keys(i))i[e]=i[e].map(e=>t[e]);return i}(t);for(const e of s){const{eid:t,cid:i}=ae(e);this.experiments.set(t,i)}this.confirmed=x(o.cf),this.contaminated=x(o.ct),this.filtered=x(o.f),this.selected=x(o.s),this.save()}checkIfConfirmed(e){return this.confirmed.has(e)}checkIfContaminated(e){return this.contaminated.has(e)}markConfirmed(e){const{config:t}=this.context;return this.confirmed.has(e)||(this.sweepOut(this.confirmed,e),this.confirmed.add(e)),J(t,"confirmation",{cid:e}),this.save(),!0}markContaminated(e,t,i){const{config:r}=this.context;return this.confirmed.has(e)?(this.contaminated.has(e)||(this.confirmed.delete(e),this.contaminated.add(e),J(r,"contamination",{cid:e,reason:t,detail:i})),this.save(),!0):(J(r,"contamination",{cid:e,reason:t,detail:i}),this.save(),!1)}markExcluded(e,t=""){const i="*:"+e;this.sweepOut(this.confirmed,i),this.sweepOut(this.filtered,i),this.sweepOut(this.selected,i),this.markFiltered(i,t)}markFiltered(e,t=""){const i=this.replaceIfExperimentSeen(e);if(!this.filtered.has(e)&&(this.sweepOut(this.filtered,e),this.filtered.add(e),e!==i)){const{eid:i,cid:r}=ae(e);u.emit("filtered",{experimentId:i,candidateId:r,reason:t})}this.save()}markSelected(e){const t=this.replaceIfExperimentSeen(e);if(!this.selected.has(e)&&(this.sweepOut(this.selected,e),this.selected.add(e),e!==t)){const{eid:t,cid:i}=ae(e);u.emit("selected",{experimentId:t,candidateId:i})}this.save()}replaceIfExperimentSeen(e){const{eid:t,cid:i}=ae(e);if(!this.experiments.has(t))return null;const r=this.experiments.get(t);return this.experiments.set(t,i),this.filtered.delete(r),this.selected.delete(r),r}save(){const{cookieDomains:e}=this.context.config,t=function(e){const t=Object.keys(e),i=t.reduce((t,i)=>function(e,t,...i){const r=x(e);for(const e of g(t))r.add(e);for(const e of[...i])for(const t of g(e))r.add(t);return r}(t,x(e[i])),x()),r={},n=g(i);for(const i of t)r[i]=e[i].map(e=>{return t=t=>e===t,n.findIndex(t);var t});return Object.assign({l:n},r)}({cf:g(this.confirmed),ct:g(this.contaminated),f:g(this.filtered),s:g(this.selected)});for(const s of e)i=C.CandidateIds,r=t,n={domain:s,millis:I},T(i,JSON.stringify(r),n);var i,r,n}sweepOut(e,t){const{eid:i}=ae(t);!function(e,t){const i=t instanceof Set?t:function(e,t){const i=x();for(const r of g(e))t(r)&&i.add(r);return i}(e,t);for(const t of g(e))i.has(t)&&e.delete(t)}(e,e=>je(e,i))}}class Ke{constructor(e){this.context=e,this.triggers=w(),o("popstate",this.rerun.bind(this)),o("pushstate_evolv",this.rerun.bind(this))}get logger(){return this.context.logger}clear(){this.detachAll(),this.triggers.clear()}add(e){this.triggers.set(e.key,e)}attachAll(){for(const[,e]of g(this.triggers))e.attach(this.context)}detachAll(){for(const[,e]of g(this.triggers))e.detach()}rerun(){this.detachAll(),this.attachAll()}}const Qe=function(){const e=r.scripts;let t=null;for(let i=0;i<e.length;i+=1){const r=e[i].dataset;if("evolvEnvironment"in r){t=r;break}}if(!t)throw new f;const i={environmentId:t.evolvEnvironment,autoLoad:(n=t.evolvAutoLoad,"false"!==n&&("true"===n||n)),apiUrl:t.evolvApiUrl,sdkUrl:t.evolvSdkUrl,editorUrl:t.evolvEditorUrl,cookieDomains:(t.evolvCookieDomains||"").split(/,\s*/)};var n,s;return Object.freeze(Object.assign({},$,(s=i,Object.keys(s).reduce((e,t)=>(void 0!==s[t]&&(e[t]=s[t]),e),{}))))}();window.evolv.runtime.resolve(new class{constructor(e){this.config=e,this.logger=A("Runtime"),this.seenTriggers=w(),this.audienceContextRef=new m(he),this._allPlans=w(),this._activePlans=w(),this.context={config:e,emit:u.emit.bind(u),logger:this.logger,state:new We},this.aeRunner=new He,this.experimentRecorder=new Ge(this.context),this.triggerManager=new Ke(this.context),u.emit("initialized",{}),"true"===F("evolv:interactiveMode")?(this.logger.info("Runtime is in interactive mode. Further execution of plans will be halted"),M(this.context)):F("_ascend_editor")&&(this.logger.info("Runtime is in editor mode. Further execution of plans will be halted"),M(this.context).then(e=>{e.loadConfig()}))}get activePlans(){return this._activePlans}get audience(){return this.audienceContextRef.current}get _audienceContext(){return this.audience}contaminate(e){(e?x([e]):this.experimentRecorder.selected).forEach(e=>{this.experimentRecorder.markContaminated(e,"user-generated")})}setAudience(e){if(this.audienceContextRef.current!==he)return void this.logger.warn("New audience will be ignored because the audience was configured by an earlier stage");const{browser:t}=e,i=j(e,["browser"]),r="web"in e?e:Object.assign({},i,{web:{client:{browser:t}}});this.audienceContextRef.current=pe(r)}updateAudience(e){if(le(e)){const t=function e(t,...i){if(!i.length)return t;const r=i.shift();if(le(t)&&le(r))for(const i in r)le(r[i])?(t[i]||Object.assign(t,{[i]:{}}),e(t[i],r[i])):Object.assign(t,{[i]:r[i]});return e(t,...i)}(this.audienceContextRef.current,e);this.audienceContextRef.current=pe(t)}else this.logger.warn("The audience has not been updated, because of an invalid argument was passed to the function")}stagePlans(e,t){this.audienceContextRef.current||this.logger.warn("An audience has not been configured. Therefore audience filters may fail to evaluate as expected"),this.triggerManager.clear();const i=new Fe(e,this.aeRunner,this.experimentRecorder,this.triggerManager,this.audienceContextRef,this.context);t(new Be(i,this.experimentRecorder));try{i.runAlwaysExecute()}catch(e){return void this.logger.warn("Execution has been halted")}i.plans.forEach(e=>{this._allPlans.set(e.id,e)}),this.executeStage(i),this.finalizeStage(i)}activate(e){if(!e)throw new TypeError("Argument 'pageId' cannot be undefined or null.");const{manualActivations:t}=this.context.state;this.revertAll(),t.add(e),this.runAll()}deactivate(e){const{manualActivations:t}=this.context.state;this.revertAll(),e?t.delete(e):t.clear(),this.runAll()}emitEvent(e){if(!e)throw new TypeError("Argument 'id' cannot be null or empty.");if(!this.seenTriggers.has(e)){const t=new Ne(e);t.attach(this.context),this.seenTriggers.set(e,t)}this.seenTriggers.get(e).trigger()}findMutations(e){return d(`[data-evolv-treatment${void 0!==e?` = '${e}'`:""}], script[data-evolv-status]`)}revertAll(){this.triggerManager.detachAll(),this.activePlans.forEach(e=>e.revert())}runAll(){this.activePlans.forEach(e=>e.run()),this.triggerManager.attachAll()}rerun(){this.revertAll(),this.runAll()}evaluatePlans(){this.audienceContextRef.current=pe(this.audienceContextRef.current),this.revertAll(),this.activePlans.clear(),this._allPlans.forEach(e=>{e.run()&&this.activePlans.set(e.id,e)}),this.triggerManager.attachAll()}executeStage(e){const{plansToAdd:t,plansToRevert:i}=e.reconcile(this.activePlans);for(const e of g(i)){const t=this.activePlans.get(e);t&&t.revert(),this.activePlans.delete(e)}for(const i of g(t)){const t=e.plans.get(i);t&&t.run()&&this.activePlans.set(i,t)}this.triggerManager.attachAll(),g(i).sort(),g(t).sort(),u.emit("stagecompleted",{uid:e.uid,number:e.number}),e.number}finalizeStage(e){const t=n.getItem("evolv:planVersion"),i=!t||2===e.number;var r;i&&e.number,r=e.uid,n.setItem("evolv:planVersion",r),e.isEmpty&&i?u.emit("skipped",{}):!e.isEmpty&&i&&u.emit("reconciled",{previous:t,current:e.uid,stageNumber:e.number})}}(Qe))}(window.evolvShims);
//# sourceMappingURL=runtime.min.mjs.map
